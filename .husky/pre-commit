#!/bin/sh

echo "Running pre-commit checks..."

cd mcp

# 1. Run lint-staged (formats and lints staged files)
echo "Running lint-staged..."
npx lint-staged || {
  echo "Lint-staged failed! Fix errors before committing."
  exit 1
}

# 2. Run type check
echo "Type checking..."
npm run typecheck || {
  echo "Type check failed! Fix errors before committing."
  exit 1
}

# 3. Run all tests
echo "Running tests..."
npm run test || {
  echo "Tests failed! All tests must pass before committing."
  exit 1
}

# 4. Check coverage threshold (only if there are test files)
if ls src/**/*.test.ts 1> /dev/null 2>&1; then
  echo "Checking coverage threshold..."
  npm run test:coverage -- --run || {
    echo "Coverage below 80%! Add more tests before committing."
    exit 1
  }
fi

echo "All pre-commit checks passed!"
